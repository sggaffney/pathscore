{% extends "base.html" %}
{% block head %}
    {{ super() }}
	<title>Results</title>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">
{% endblock %}


{% block page_content %}

<!-- BETTER TO HAVE AN OBJECT-->


<!--<div class="page-header">-->
	<!--<h1>Pathway Dendrogram</h1>-->
<!--</div>-->

<!--<div class="panel panel-default">-->
	<!--<div class="panel-body">-->
		<form class="form-inline" action="/compare" method="get">
			<div class="form-group" style="margin: 0px 0px 15px 0px;">
				<label for="projSelectionA">Project:</label>
                <select class="form-control" id="projSelectionA" name="proj_a">
				{% for proj in projects %}
					{% if current_proj_a.file_id == proj.file_id %}
						<option value="{{ proj.file_id }}" selected="selected">
					{% else %}
						<option value="{{ proj.file_id }}">
					{% endif %}
						{{ proj.get_local_filename() }}
						</option>
				{% endfor %}
				</select>
            </div>
            <div class="form-group" style="margin: 0px 0px 15px 0px;">
                <select class="form-control" id="projSelectionB" name="proj_b">
				{% for proj in projects %}
					{% if current_proj_b.file_id == proj.file_id %}
						<option value="{{ proj.file_id }}" selected="selected">
					{% else %}
						<option value="{{ proj.file_id }}">
					{% endif %}
						{{ proj.get_local_filename() }}
						</option>
				{% endfor %}
				</select>
            </div>
            <button type="submit" class="btn btn-default">Compare</button>
        </form>
    <!--</div>-->
<!--</div>-->

<div class="bokeh">
 {{ bokeh_div|safe }}
</div>
<button id="selectButton">Selection info</button>

<div id="imageContainer" class="padded">
</div>

{% endblock %}


{% block scripts %}
{{super()}}

 <link rel="stylesheet" href="http://cdn.pydata.org/bokeh-0.7.1.min.css" type="text/css" />
 <script type="text/javascript" src="http://cdn.pydata.org/bokeh-0.7.1.min.js"></script>
 {{ bokeh_script|safe }}
<script>
    $(function() {
		{# current_proj_a, current_proj_b, inds_use_a, inds_use_b, js_name_a, js_name_b #}
        $selectButton = $('#selectButton');
		$imageContainer = $('#imageContainer');
		$projSelectionA = $('#projSelectionA');
		$projSelectionB = $('#projSelectionB');

		projIds = [$projSelectionA.val(), $projSelectionB.val()];  // global for project id
		var inds_use_a = {{inds_use_a}};
		var inds_use_b = {{inds_use_b}};

		$.getScript( "static/data/{{ user_id }}/{{current_proj_a.file_id}}/{{js_name_a}}", function( data, textStatus, jqxhr ) {
			console.log( "Loaded project A." );
			pwayList_a = [];
			for(var i=0; i<inds_use_a.length; i++){
				pwayList_a[pwayList_a.length] = pwayList[inds_use_a[i]]; // reduce to common pways
			}
			$.getScript( "static/data/{{ user_id }}/{{current_proj_b.file_id}}/{{js_name_b}}", function( data, textStatus, jqxhr ) {
				console.log( "Loaded project B." );
				// pwayList loaded
				pwayList_b = [];
				for(var i=0; i<inds_use_b.length; i++){
					pwayList_b[pwayList_b.length] = pwayList[inds_use_b[i]]; // reduce to common pways
				}
				$selectButton.click(updateImages);
			});
		});

	});

	function updateImages(){
		$imageContainer.empty();  //clear old pathway images

		var indices = Bokeh.ColumnDataSource.Collection.models[0].attributes.selected

		if(!indices.length){
			$imageContainer.text("No pathways selected");
			return
		}
//		else {
//			$imageContainer.text(indices.length + " pathway(s) selected.");
//		}
		var use_pways_a = [];
		for(var i=0; i<indices.length; i++){
			use_pways_a.push(pwayList_a[indices[i]])
		}
		var use_pways_b = [];
		for(var i=0; i<indices.length; i++){
			use_pways_b.push(pwayList_b[indices[i]])
		}
		var pway_lists = [use_pways_a, use_pways_b];

//		console.log(use_pways[0])

		for (var pi = 0; pi < indices.length; pi++) {
			for(var proj_ind=0; proj_ind<pway_lists.length; proj_ind++) {
				var use_pways = pway_lists[proj_ind];
				var ngenes = use_pways[pi].geneSet.length;
				var max_height = 25 * ngenes + 80;
				$imageContainer.append(
					'<div class="panel panel-primary">' +
					'<div class="panel-heading">' +
					'<h2 class="panel-title"><a href="' + root_url + use_pways[pi]['url'] + '" target="_blank">'
					+ use_pways[pi]['name'] + '</a>' + ' (p=' + use_pways[pi]['pval'] + ') </h2>' +
					use_pways[pi]['brief'] + ' (' + use_pways[pi]['contrib'] + ')</div>' +
					'<div class="panel-body" style="padding:0"><code class="p-lengths">Gene lengths: ' +
					'<span class="keyword-text">min</span>=' + use_pways[pi]['lengths'][0] + 'kbp (' + use_pways[pi]['lengths'][1] + '); ' +
					'<span class="keyword-text">max</span>=' + use_pways[pi]['lengths'][2] + 'kbp (' + use_pways[pi]['lengths'][3] + '); ' +
					'<span class="keyword-text">avg</span>=' + use_pways[pi]['lengths'][4] + 'kbp; ' +
					'<span class="keyword-text">var</span>=' + use_pways[pi]['lengths'][5] + '</code>'
					+ '<div class="svg_target ui-widget-content">' +
					'<img src="static/data/{{ user_id }}/' + projIds[proj_ind] + '/pathways_svg/' + use_pways[pi]['id'] + '.svgz" ' +
					'alt="' + use_pways[pi]['id'] + '.svgz" ></img>'
					+ '</div>'
					+ '<div class="svg_matrix ui-widget-content"><div class="pway_size" style="display:none">'
					+ JSON.stringify({
						"n_genes": use_pways[pi].geneSet.length,
						"expanded": false
					}) + '</div>' +
					'<img src="static/data/{{ user_id }}/' + projIds[proj_ind] + '/matrix_svg/' + use_pways[pi]['id'] + '.svgz" ' +
					'px alt="' + use_pways[pi]['id'] + '.svgz" style="max-height:' + max_height + 'px;"></img>' //
					+ '</div></div>'
				);
				// 'height=1024px width=1024px
				//'height=' + (use_pways[pi].geneSet.length*25+80) +
			}
		}





	}






</script>

{% endblock %}

