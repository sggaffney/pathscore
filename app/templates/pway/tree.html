{% extends "base.html" %}
{% block head %}
    {{ super() }}
	<title>Results</title>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">
{% endblock %}

{% block page_content %}

<!-- BETTER TO HAVE AN OBJECT-->


<!--<div class="page-header">-->
	<!--<h1>Pathway Dendrogram</h1>-->
<!--</div>-->

<!--<div class="panel panel-default">-->
	<!--<div class="panel-body">-->
		<form class="form-inline" action="/tree" method="get">
			<div class="form-group" style="margin: 0px 0px 15px 0px;">
				<label for="projSelection">Project:</label>
                <select class="form-control" id="projSelection" name="proj">
				{% for proj in projects %}
					{% if current_proj.file_id == proj.file_id %}
						<option value="{{ proj.file_id }}" selected="selected">
					{% else %}
						<option value="{{ proj.file_id }}">
					{% endif %}
						{{ proj.get_local_filename() }}
						</option>
				{% endfor %}
				</select>
			</div>
        </form>
    <!--</div>-->
<!--</div>-->


<div id="resizable-tree" class="ui-widget-content">
    <div class="tree-holder">
        <div class="dendrogram">
            <img src="{{ tree_path }}" alt="dendrogram">
        </div>


        <div class="dendrotext">{% for proj_id in names_odict %}<button class="tree-button" data-pid="{{ proj_id }}">{{ names_odict[proj_id]|safe }}</button>
            {% endfor%}</div>
    </div>
</div>

<div id="imageContainer" class="padded">
</div>

{% endblock %}

{% block scripts %}
{{super()}}

<script src="//code.jquery.com/ui/1.11.3/jquery-ui.js"></script>
<script>
    $(function() {
        $("#resizable-tree").resizable({handles: "s"});
        $imageContainer = $('#imageContainer');
        $treebuttons = $('.tree-button');
        vogelstein = ['ABL1', 'ACVR1B', 'AKT1', 'ALK', 'APC', 'AR', 'ARID1A', 'ARID1B', 'ARID2', 'ASXL1', 'ATM', 'ATRX', 'AXIN1', 'B2M', 'BAP1', 'BCL2', 'BCOR', 'BRAF', 'BRCA1', 'BRCA2', 'CARD11', 'CASP8', 'CBL', 'CDC73', 'CDH1', 'CDKN2A', 'CEBPA', 'CIC', 'CREBBP', 'CRLF2', 'CSF1R', 'CTNNB1', 'CYLD', 'DAXX', 'DNMT1', 'DNMT3A', 'EGFR', 'EP300', 'ERBB2', 'EZH2', 'AMER1', 'FBXW7', 'FGFR2', 'FGFR3', 'FLT3', 'FOXL2', 'FUBP1', 'GATA1', 'GATA2', 'GATA3', 'GNA11', 'GNAQ', 'GNAS', 'H3F3A', 'HIST1H3B', 'HNF1A', 'HRAS', 'IDH1', 'IDH2', 'JAK1', 'JAK2', 'JAK3', 'KDM5C', 'KDM6A', 'KIT', 'KLF4', 'KRAS', 'MAP2K1', 'MAP3K1', 'MED12', 'MEN1', 'MET', 'MLH1', 'KMT2B', 'KMT2C', 'MPL', 'MSH2', 'MSH6', 'MYD88', 'NCOR1', 'NF1', 'NF2', 'NFE2L2', 'NOTCH1', 'NOTCH2', 'NPM1', 'NRAS', 'PAX5', 'PBRM1', 'PDGFRA', 'PHF6', 'PIK3CA', 'PIK3R1', 'PPP2R1A', 'PRDM1', 'PTCH1', 'PTEN', 'PTPN11', 'RB1', 'RET', 'RNF43', 'RUNX1', 'SETD2', 'SETBP1', 'SF3B1', 'SMAD2', 'SMAD4', 'SMARCA4', 'SMARCB1', 'SMO', 'SOCS1', 'SOX9', 'SPOP', 'SRSF2', 'STAG2', 'STK11', 'TET2', 'TNFAIP3', 'TRAF7', 'TP53', 'TSC1', 'TSHR', 'U2AF1', 'VHL', 'WT1', 'ALPK2', 'BCLAF1', 'CD1D', 'CEP76', 'CHD8', 'DNER', 'ELF3', 'EZH1', 'ARHGAP35', 'HIST1H4E', 'HLA-B', 'IRF6', 'MAP4K3', 'MBD1', 'MGA', 'MYOCD', 'PCBP1', 'QKI', 'RAD21', 'RHEB', 'RHOA', 'RPL5', 'RXRA', 'SETDB1', 'SOS1', 'STX2', 'TAP1', 'TNF', 'TP53BP1', 'TPX2', 'TRIM23', 'ZNF750', 'ZRANB3'];

        //pway_dict = {};  //set by get_pway_dict when projId set/refreshed
        //initialView = true;

        $.getScript('{{"static/data/" ~ current_user.id ~ "/" ~ current_proj.file_id ~ "/" ~ proj_names[current_proj.file_id|int] ~ ".js" }}', function( data, textStatus, jqxhr ) {
                // console.log( data ); // Data returned
                // console.log( textStatus ); // Success
                // console.log( jqxhr.status ); // 200
                console.log( "Load was performed." );
                n_pways = pwayList.length;
                initialView = true;
                get_pway_dict();
                set_hover_action();}
        );

        $projSelection = $('#projSelection');
        projId = $projSelection.val();
        $projSelection.change(  // sets projId global
            function () {
                projId = $projSelection.val();
                $('form').submit()
            }
        );

    });


    function set_hover_action() {
        $treebuttons.mouseenter(function () {
            $imageContainer.empty();  //clear old pathway images
            if(initialView){
                $('div#resizable-tree').height(300);
                initialView = false;
            }
            var pid = this.dataset.pid;
            var projId = {{ current_proj.file_id }};

            var driver_list = [];
            var temp_pway = pway_dict[pid];
            $.each(temp_pway.geneSet, function(gi, gene_name){
                if( $.inArray(gene_name, vogelstein)>-1 ){
                    driver_list.push(gene_name)
                }
            });
            driver_list.sort();
            var driver_text = "";
            if (driver_list.length){
                driver_text = '<br>&nbsp;Vogelstein drivers: ' + driver_list.join(', ');
            }

            var ngenes = pway_dict[pid].geneSet.length;
            var max_height = 25*ngenes + 80;
            impath = "{{ 'static/data/' ~ current_user.id ~ '/' ~ current_proj.file_id ~ '/matrix_svg/' }}" + pid + '.svgz';
            $imageContainer.append(
                    '<div class="panel panel-primary">' +
                    '<div class="panel-heading">' +
                    '<h2 class="panel-title"><a href="' + root_url + pway_dict[pid]['url'] + '" target="_blank">'
                    + pway_dict[pid]['name'] + '</a>' + ' (p=' + pway_dict[pid]['pval'] + ') </h2>' +
                    pway_dict[pid]['brief'] + ' (' + pway_dict[pid]['contrib'] + ')</div>' +
                    '<div class="panel-body" style="padding:0"><code class="p-lengths">Gene lengths: ' +
                    '<span class="keyword-text">min</span>=' + pway_dict[pid]['lengths'][0] + 'kbp (' + pway_dict[pid]['lengths'][1] + '); ' +
                    '<span class="keyword-text">max</span>=' + pway_dict[pid]['lengths'][2] + 'kbp (' + pway_dict[pid]['lengths'][3] + '); ' +
                    '<span class="keyword-text">avg</span>=' + pway_dict[pid]['lengths'][4] + 'kbp; ' +
                    '<span class="keyword-text">var</span>=' + pway_dict[pid]['lengths'][5] + driver_text + '</code>'
                    + '<div class="svg_target ui-widget-content">' +
                    '<img src="static/data/{{ user_id }}/' + projId + '/pathways_svg/' + pway_dict[pid]['id'] + '.svgz" ' +
                    'alt="' + pway_dict[pid]['id'] + '.svgz"></img>'
                    + '</div>'
                    + '<div class="svg_matrix ui-widget-content" data-ngenes="' + ngenes +'" data-expanded=false><div class="pway_size" style="display:none">'
                    + JSON.stringify({
                        "n_genes": pway_dict[pid].geneSet.length,
                        "expanded": false
                    }) + '</div>' +
                    '<img src="static/data/{{ user_id }}/' + projId + '/matrix_svg/' + pway_dict[pid]['id'] + '.svgz" ' +
                    'px alt="' + pway_dict[pid]['id'] + '.svgz" style="max-height:' + max_height + 'px;"></img>' //
                    + '</div></div>');
            $(".svg_matrix").click(expandMatrixImage);
        });
    }

    function get_pway_dict(){
        pway_dict = {};
        for (var i=0,  tot=n_pways; i < tot; i++) {
            temp_pway = pwayList.pop();
            pway_dict[temp_pway.id] = temp_pway;
        }
    }

	function expandMatrixImage(event){
		var $im = $(event.target);
		var $statusDiv = $im.parent().children()[0];
		var im_status = jQuery.parseJSON($statusDiv.textContent);
		var n_genes = im_status.n_genes;
		var expanded = im_status.expanded;
		if(!expanded)
			$im.css('height',25*n_genes + 80);
		else
			$im.css('height','inherit');
		im_status.expanded = !im_status.expanded;
		$statusDiv.textContent = JSON.stringify(im_status);

	}


</script>

{% endblock %}

